<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhotoBooth</title>
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Inter:wght@400;500;700&family=Pacifico&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: #fffacd;
  padding: 20px;
  position: relative;
  min-height: 100vh;
  box-sizing: border-box;
  justify-content: center
}

h1 {
  font-family: 'Dancing Script', cursive;
  font-size: 3.5rem;
  color: #d94680;
  margin-bottom: -5px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

h2 {
  color: #333;
  margin-bottom: 5px;
  font-weight: 700
}

p.subtitle {
  font-family: 'Pacifico', cursive;
  font-size: 1.3em;
  color: #ff69b4;
  margin-top: 0;
  margin-bottom: 20px;
  text-shadow: 0 1px 2px rgba(255,255,255,0.5);
}

.hidden {
  display: none !important
}

#photoboothApp {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%
}

.booth-container {
  display: flex;
  flex-direction: column;
  gap: 0;
  align-items: center;
  justify-content: center;
  margin: 25px 0;
  width: 100%;
  max-width: 640px;
}

video {
  width: 100%;
  height: auto;
  aspect-ratio: 16 / 9;
  object-fit: cover;
  transform: scaleX(-1); /* Ch·ªâ l·∫≠t video tr·ª±c ti·∫øp */
  border: 6px solid #ff69b4;
  border-radius: 15px;
  background-color: white;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  transition: filter 0.3s ease;
}

canvas {
  display: none;
}

button {
  padding: 10px 20px;
  margin: 5px;
  background-color: #ff69b4;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
  font-size: 16px;
  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}

button:hover {
  background-color: #e0529d;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#startButton {
  background: linear-gradient(45deg, #ff69b4, #f72a7b);
  padding: 12px 25px;
  font-size: 18px;
}
#restartButton {
  background: linear-gradient(45deg, #ffd700, #f7971e);
  padding: 12px 25px;
  font-size: 18px;
}
#downloadButton, #confirmEmojiBtn {
  background: linear-gradient(45deg, #8e2de2, #4a00e0);
  padding: 12px 25px;
  font-size: 18px;
}
#downloadButton:hover, #confirmEmojiBtn:hover {
  background: linear-gradient(45deg, #a045ed, #5a10ed);
}

#controls {
  margin-bottom: 15px
}

#statusContainer {
  display: flex;
  justify-content: space-around;
  width: 100%;
  max-width: 700px;
  background: #fff;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  margin-top: 20px
}

.status-item {
  text-align: center;
  font-size: 19px;
  font-weight: bold;
  color: #444
}

.status-item span {
  display: block;
  font-size: 26px;
  color: #ff69b4;
  margin-top: 6px
}

#filterControls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px
}

.filter-btn {
  background-color: #f8c5e0;
  color: #555;
  font-size: 13px;
  padding: 7px 14px;
  border-radius: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
}

.filter-btn:hover {
  background-color: #f5b0d0
}

.photo-actions button {
  background-color: #ff4d4d
}

.photo-actions button:hover {
  background-color: #e63939
}

.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 12px;
  width: 100%;
  max-width: 800px;
  margin-top: 25px
}

.photo-item {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  padding-bottom: 8px;
  transition: transform 0.2s ease
}

.photo-item:hover {
  transform: translateY(-5px)
}

.photo-item img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 10px;
  /* B·ªè transform: scaleX(-1) ·ªü ƒë√¢y */
}

.photo-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 8px
}

.photo-actions input[type="checkbox"] {
  transform: scale(1.3);
  cursor: pointer
}

.photo-actions input[type="checkbox"]:disabled {
  cursor: not-allowed
}

.counter {
  margin: 10px;
  font-size: 17px;
  color: #444;
  font-weight: bold
}

#selectionMessage {
  color: #dc3545;
  font-size: 15px;
  height: 22px;
  font-weight: bold
}

#emojiContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  margin-top: 20px;
  width: 100%;
  max-width: 700px;
}

#emojiContainer p {
  margin: 0 0 10px 0;
  font-weight: 500;
  color: #555;
}

#emojiInput {
  width: 80%;
  padding: 10px;
  font-size: 20px;
  text-align: center;
  border: 2px solid #f8c5e0;
  border-radius: 8px;
}
</style>
</head>

<body>
<div id="photoboothApp">
  <h1>‚ú® PhotoBooth ‚ú®</h1>
  <p class="subtitle">iuPT üíñ</p>
  
  <div id="statusContainer">
    <div class="status-item">Ch·ª•p sau...<span id="timerDisplay">12</span></div>
    <div class="status-item">S·ªë ·∫£nh<span id="photoCountDisplay">0 / 10</span></div>
  </div>
  <div class="booth-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  <div id="filterControls">
    <button class="filter-btn" data-filter="none">B√¨nh th∆∞·ªùng</button>
    <button class="filter-btn" data-filter="tokyo">Tokyo</button>
    <button class="filter-btn" data-filter="seoul">Seoul</button>
    <button class="filter-btn" data-filter="paris">Paris</button>
    <button class="filter-btn" data-filter="vintage-noise">Vintage</button>
  </div>
  <div id="controls">
    <button id="startButton">‚ñ∂ B·∫Øt ƒë·∫ßu ch·ª•p</button>
    <button id="restartButton" class="hidden">üîÑ Ch·ª•p l·∫°i</button>
  </div>
  <hr style="width: 80%; border: 1px solid #ddd; margin: 15px 0;">
  <h2>Th∆∞ vi·ªán ·∫£nh</h2>
  <p>Em ch·ª•p xong r√πi, gi·ªù ch·ªçn 6 ·∫£nh ƒë·∫πp nh·∫•t nha!</p>
  
  <div id="emojiContainer" class="hidden">
    <p>Ch·ªçn t·ªëi ƒëa 4 emoji em mu·ªën th√™m v√†o ·∫£nh n√® üíñ</p>
    <input type="text" id="emojiInput" placeholder="üíñ‚ú®üòÇü•∞">
    <button id="confirmEmojiBtn">X√°c nh·∫≠n Emoji</button>
  </div>

  <div class="counter">·∫¢nh ƒë√£ ch·ªçn: <span id="selectedCount">0</span> / 6</div>
  <p id="selectionMessage"></p>
  <div class="gallery" id="photoGallery"></div>
  <button id="downloadButton" disabled>‚¨áÔ∏è T·∫£i 6 ·∫£nh ƒë√£ ch·ªçn</button>
</div>

<div id="stickerAssets" style="display: none;">
  <svg id="svg-bear" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-cat" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2ZM7.5 7.5C7.5 6.67157 8.17157 6 9 6C9.82843 6 10.5 6.67157 10.5 7.5C10.5 8.32843 9.82843 9 9 9C8.17157 9 7.5 8.32843 7.5 7.5ZM13.5 7.5C13.5 6.67157 14.1716 6 15 6C15.8284 6 16.5 6.67157 16.5 7.5C16.5 8.32843 15.8284 9 15 9C14.1716 9 13.5 8.32843 13.5 7.5ZM12 11.5C10.6193 11.5 9.5 12.6193 9.5 14C9.5 15.3807 10.6193 16.5 12 16.5C13.3807 16.5 14.5 15.3807 14.5 14C14.5 12.6193 13.3807 11.5 12 11.5ZM3 9C3 8.44772 3.44772 8 4 8H6C6.55228 8 7 8.44772 7 9C7 9.55228 6.55228 10 6 10H4C3.44772 10 3 9.55228 3 9ZM18 9C18 8.44772 18.4477 8 19 8H21C21.5523 8 22 8.44772 22 9C22 9.55228 21.5523 10 21 10H19C18.4477 10 18 9.55228 18 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-cloud" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-lollipop" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C7.03194 2 3 6.03194 3 11C3 15.9681 7.03194 20 12 20C16.9681 20 21 15.9681 21 11C21 6.03194 16.9681 2 12 2ZM12 4C15.866 4 19 7.13401 19 11C19 14.866 15.866 18 12 18C8.13401 18 5 14.866 5 11C5 7.13401 8.13401 4 12 4ZM12 6C11.4477 6 11 6.44772 11 7C11 7.55228 11.4477 8 12 8C12.5523 8 13 7.55228 13 7C13 6.44772 12.5523 6 12 6ZM12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-cupcake" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-gift" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2ZM7.5 7.5C7.5 6.67157 8.17157 6 9 6C9.82843 6 10.5 6.67157 10.5 7.5C10.5 8.32843 9.82843 9 9 9C8.17157 9 7.5 8.32843 7.5 7.5ZM13.5 7.5C13.5 6.67157 14.1716 6 15 6C15.8284 6 16.5 6.67157 16.5 7.5C16.5 8.32843 15.8284 9 15 9C14.1716 9 13.5 8.32843 13.5 7.5ZM12 11.5C10.6193 11.5 9.5 12.6193 9.5 14C9.5 15.3807 10.6193 16.5 12 16.5C13.3807 16.5 14.5 15.3807 14.5 14C14.5 12.6193 13.3807 11.5 12 11.5ZM3 9C3 8.44772 3.44772 8 4 8H6C6.55228 8 7 8.44772 7 9C7 9.55228 6.55228 10 6 10H4C3.44772 10 3 9.55228 3 9ZM18 9C18 8.44772 18.4477 8 19 8H21C21.5523 8 22 8.44772 22 9C22 9.55228 21.5523 10 21 10H19C18.4477 10 18 9.55228 18 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-frog" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-chick" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2ZM7.5 7.5C7.5 6.67157 8.17157 6 9 6C9.82843 6 10.5 6.67157 10.5 7.5C10.5 8.32843 9.82843 9 9 9C8.17157 9 7.5 8.32843 7.5 7.5ZM13.5 7.5C13.5 6.67157 14.1716 6 15 6C15.8284 6 16.5 6.67157 16.5 7.5C16.5 8.32843 15.8284 9 15 9C14.1716 9 13.5 8.32843 13.5 7.5ZM12 11.5C10.6193 11.5 9.5 12.6193 9.5 14C9.5 15.3807 10.6193 16.5 12 16.5C13.3807 16.5 14.5 15.3807 14.5 14C14.5 12.6193 13.3807 11.5 12 11.5ZM3 9C3 8.44772 3.44772 8 4 8H6C6.55228 8 7 8.44772 7 9C7 9.55228 6.55228 10 6 10H4C3.44772 10 3 9.55228 3 9ZM18 9C18 8.44772 18.4477 8 19 8H21C21.5523 8 22 8.44772 22 9C22 9.55228 21.5523 10 21 10H19C18.4477 10 18 9.55228 18 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-christmas-tree" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C11.4477 2 11 2.44772 11 3V6H9.5C9.22386 6 9 6.22386 9 6.5C9 6.77614 9.22386 7 9.5 7H11V8H9.5C9.22386 8 9 8.22386 9 8.5C9 8.77614 9.22386 9 9.5 9H11V10H9.5C9.22386 10 9 10.2239 9 10.5C9 10.7761 9.22386 11 9.5 11H11V12H9.5C9.22386 12 9 12.2239 9 12.5C9 12.7761 9.22386 13 9.5 13H11V14H9.5C9.22386 14 9 14.2239 9 14.5C9 14.7761 9.22386 15 9.5 15H11V16H9.5C9.22386 16 9 16.2239 9 16.5C9 16.7761 9.22386 17 9.5 17H11V18H9.5C9.22386 18 9 18.2239 9 18.5C9 18.7761 9.22386 19 9.5 19H11V20H9.5C9.22386 20 9 20.2239 9 20.5C9 20.7761 9.22386 21 9.5 21H11V22C11 22.5523 11.4477 23 12 23C12.5523 23 13 22.5523 13 22V3C13 2.44772 12.5523 2 12 2ZM12 4C12.5523 4 13 4.44772 13 5C13 5.55228 12.5523 6 12 6C11.4477 6 11 5.55228 11 5C11 4.44772 11.4477 4 12 4Z" fill="#228B22"/>
  </svg>
  <svg id="svg-duck" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2ZM7.5 7.5C7.5 6.67157 8.17157 6 9 6C9.82843 6 10.5 6.67157 10.5 7.5C10.5 8.32843 9.82843 9 9 9C8.17157 9 7.5 8.32843 7.5 7.5ZM13.5 7.5C13.5 6.67157 14.1716 6 15 6C15.8284 6 16.5 6.67157 16.5 7.5C16.5 8.32843 15.8284 9 15 9C14.1716 9 13.5 8.32843 13.5 7.5ZM12 11.5C10.6193 11.5 9.5 12.6193 9.5 14C9.5 15.3807 10.6193 16.5 12 16.5C13.3807 16.5 14.5 15.3807 14.5 14C14.5 12.6193 13.3807 11.5 12 11.5ZM3 9C3 8.44772 3.44772 8 4 8H6C6.55228 8 7 8.44772 7 9C7 9.55228 6.55228 10 6 10H4C3.44772 10 3 9.55228 3 9ZM18 9C18 8.44772 18.4477 8 19 8H21C21.5523 8 22 8.44772 22 9C22 9.55228 21.5523 10 21 10H19C18.4477 10 18 9.55228 18 9Z" fill="#ffb6c1"/>
  </svg>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  
  const PHOTO_COUNTDOWN = 12;
  const MAX_PHOTOS = 10;
  const MAX_SELECTIONS = 6;
  const MAX_EMOJIS = 4;
  const EMOJI_RANDOM_AREA_PADDING = 100; // V√πng an to√†n xung quanh emoji

  let timer;
  let photoCountdownValue = PHOTO_COUNTDOWN;
  let photoCount = 0;
  let isSessionActive = false;
  let currentFilterStyle = 'none';
  let userEmojis = '';
  
  const photoboothApp = document.getElementById('photoboothApp');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const photoGallery = document.getElementById('photoGallery');
  const selectedCountSpan = document.getElementById('selectedCount');
  const startButton = document.getElementById('startButton');
  const restartButton = document.getElementById('restartButton');
  const downloadButton = document.getElementById('downloadButton');
  const timerDisplay = document.getElementById('timerDisplay');
  const photoCountDisplay = document.getElementById('photoCountDisplay');
  const selectionMessage = document.getElementById('selectionMessage');
  const filterButtons = document.querySelectorAll('#filterControls .filter-btn');
  const emojiContainer = document.getElementById('emojiContainer');
  const emojiInput = document.getElementById('emojiInput');
  const confirmEmojiBtn = document.getElementById('confirmEmojiBtn');

  // H√†m chuy·ªÉn SVG th√†nh Image
  async function svgToImage(svgElement) {
      return new Promise((resolve, reject) => {
          const svgData = new XMLSerializer().serializeToString(svgElement);
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = (e) => reject(new Error('L·ªói SVG: ' + e));
          img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
      });
  }

  // T·∫£i sticker SVG (th√™m sticker m·ªõi)
  const stickerImages = {};
  async function loadSvgStickers() {
      const stickerIds = ['svg-bear', 'svg-cat', 'svg-cloud', 'svg-lollipop', 'svg-cupcake', 'svg-gift', 'svg-frog', 'svg-chick', 'svg-christmas-tree', 'svg-duck'];
      for (const id of stickerIds) {
          const svgElement = document.getElementById(id);
          if (svgElement) {
              try {
                  const img = await svgToImage(svgElement);
                  stickerImages[id] = img;
              } catch (e) {
                  console.error(`Kh√¥ng th·ªÉ t·∫£i sticker ${id}:`, e);
              }
          }
      }
      console.log('Stickers SVG ƒë√£ ƒë∆∞·ª£c t·∫£i!');
  }
  
  loadSvgStickers();

  // B·∫Øt ƒë·∫ßu camera v√† reset UI ngay khi v√†o
  startCamera();
  resetUI();

  // G√°n s·ª± ki·ªán cho c√°c n√∫t
  startButton.addEventListener('click', startSession);
  restartButton.addEventListener('click', restartSession);
  downloadButton.addEventListener('click', downloadSelectedPhotos);
  
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filter = button.dataset.filter;
      applyFilter(filter);
    });
  });

  emojiInput.addEventListener('input', function(e) {
      const emojiRegex = /[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{2B50}]+/ug;
      const emojis = (e.target.value.match(emojiRegex) || []).join('');
      const limitedEmojis = Array.from(emojis).slice(0, MAX_EMOJIS).join('');
      e.target.value = limitedEmojis;
  });

  confirmEmojiBtn.addEventListener('click', function() {
      userEmojis = emojiInput.value;
      emojiContainer.classList.add('hidden');
      downloadButton.disabled = false;
      alert('ƒê√£ l∆∞u emoji! Gi·ªù em t·∫£i ·∫£nh v·ªÅ nha üíñ');
  });
  
  function startCamera() {
    let constraints = {
      video: {
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        facingMode: 'user'
      }
    };

    navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
      video.srcObject = stream;
    }).catch(error => {
      console.error('L·ªói khi l·∫•y camera 1920x1080:', error);
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
        }).catch(err2 => {
          alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + err2.message);
        });
    });
  }
  
  function applyFilter(filter) {
    let filterValue = 'none';
    switch (filter) {
      case 'tokyo':
        filterValue = 'contrast(1.1) brightness(1.1) saturate(0)';
        break;
      case 'seoul':
        filterValue = 'saturate(1.3) contrast(1.1) sepia(0.2)';
        break;
      case 'paris':
        filterValue = 'contrast(0.9) brightness(1.2) saturate(0.8) hue-rotate(-10deg)';
        break;
      case 'vintage-noise':
        filterValue = 'sepia(0.5) contrast(1.2) brightness(0.9) saturate(0.8)';
        break;
      case 'none':
      default:
        filterValue = 'none';
    }
    video.style.filter = filterValue;
    currentFilterStyle = filterValue;
  }
  
  function resetUI() {
    clearInterval(timer);
    isSessionActive = false;
    
    photoGallery.innerHTML = '';
    photoCountdownValue = PHOTO_COUNTDOWN;
    photoCount = 0;
    userEmojis = '';
    
    timerDisplay.textContent = photoCountdownValue;
    photoCountDisplay.textContent = `0 / ${MAX_PHOTOS}`;
    selectedCountSpan.textContent = '0';
    selectionMessage.textContent = '';
    
    video.style.filter = 'none';
    currentFilterStyle = 'none';
    
    startButton.classList.remove('hidden');
    restartButton.classList.add('hidden');
    downloadButton.disabled = true;
    emojiContainer.classList.add('hidden');
    emojiInput.value = '';
    disableCheckboxes(true);
  }
  
  function startSession() {
    isSessionActive = true;
    startButton.classList.add('hidden');
    restartButton.classList.remove('hidden');
    startPhotoCountdown();
  }

  function startPhotoCountdown() {
    if (!isSessionActive) return;

    photoCountdownValue = PHOTO_COUNTDOWN;
    timerDisplay.textContent = photoCountdownValue;
    
    clearInterval(timer);
    timer = setInterval(updatePhotoCountdown, 1000);
  }

  function updatePhotoCountdown() {
    if (!isSessionActive) {
      clearInterval(timer);
      return;
    }
    
    photoCountdownValue--;
    timerDisplay.textContent = photoCountdownValue;
    
    if (photoCountdownValue <= 0) {
      clearInterval(timer);
      takePhoto();
      
      if (photoCount < MAX_PHOTOS) {
        startPhotoCountdown();
      } else {
        endSession();
      }
    }
  }

  function endSession() {
    isSessionActive = false;
    clearInterval(timer);
    
    timerDisplay.textContent = "Xong!";
    restartButton.classList.add('hidden');
    
    disableCheckboxes(false);
    
    emojiContainer.classList.remove('hidden');
    alert(`ƒê√£ ch·ª•p xong ${MAX_PHOTOS} ·∫£nh! Gi·ªù em ch·ªçn 6 t·∫•m ƒë·∫πp nh·∫•t v√† nh·∫≠p emoji n√† ‚ú®`);
  }
  
  function restartSession() {
    if (confirm('Em c√≥ ch·∫Øc mu·ªën l√†m l·∫°i hongg? ·∫¢nh s·∫Ω b·ªã xo√° h·∫øt ƒë√≥ nha ü•∫')) {
      isSessionActive = false; 
      clearInterval(timer);
      resetUI();
    }
  }
  
  function disableCheckboxes(isDisabled) {
    const checkboxes = document.querySelectorAll('.photo-item input[type="checkbox"]');
    checkboxes.forEach(cb => {
      cb.disabled = isDisabled;
    });
  }

  function addCanvasNoise(ctx, width, height) {
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      for (let i = 0; i < data.length; i += 4) {
          const noise = (Math.random() - 0.5) * 50;
          data[i] = Math.max(0, Math.min(255, data[i] + noise));
          data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
          data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
      }
      ctx.putImageData(imageData, 0, 0);
  }

  function takePhoto() {
    photoCount++;
    photoCountDisplay.textContent = `${photoCount} / ${MAX_PHOTOS}`;
    
    const vWidth = video.videoWidth;
    const vHeight = video.videoHeight;
    const vRatio = vWidth / vHeight;
    
    const targetWidth = 1920;
    const targetHeight = 1080;
    const targetRatio = targetWidth / targetHeight;
    
    canvas.width = targetWidth;
    canvas.height = targetHeight;
    
    let sWidth, sHeight, sX, sY;
    if (vRatio > targetRatio) {
        sHeight = vHeight;
        sWidth = vHeight * targetRatio;
        sX = (vWidth - sWidth) / 2;
        sY = 0;
    } else {
        sWidth = vWidth;
        sHeight = vWidth / targetRatio;
        sX = 0;
        sY = (vHeight - sHeight) / 2;
    }
    
    context.filter = currentFilterStyle;
    
    // ƒê·∫£m b·∫£o ·∫£nh xu·∫•t ra kh√¥ng b·ªã l·∫≠t
    context.save();
    context.scale(-1, 1); // L·∫≠t ·∫£nh ƒë·ªÉ ƒë√∫ng chi·ªÅu nh∆∞ camera
    context.drawImage(
        video,
        sX, sY, sWidth, sHeight,
        -targetWidth, 0, targetWidth, targetHeight
    );
    context.restore();
    
    if (currentFilterStyle.includes('sepia')) {
        addCanvasNoise(context, targetWidth, targetHeight);
    }
    
    context.filter = 'none';
    
    const dataURL = canvas.toDataURL('image/png');
    addPhotoToGallery(dataURL);
  }
  
  function addPhotoToGallery(dataURL) {
    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    // B·ªè transform: scaleX(-1) ·ªü ƒë√¢y
    photoItem.innerHTML = `<img src="${dataURL}">`; 
    
    const actions = document.createElement('div');
    actions.className = 'photo-actions';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.disabled = true;
    checkbox.onchange = (e) => updateSelectedCount(e);
    
    actions.appendChild(checkbox);
    photoItem.appendChild(actions);
    photoGallery.appendChild(photoItem);
  }
  
  function updateSelectedCount(event) {
    const checkboxes = document.querySelectorAll('.photo-item input[type="checkbox"]');
    let count = 0;
    checkboxes.forEach(cb => {
      if (cb.checked) count++;
    });
    if (count > MAX_SELECTIONS) {
      event.target.checked = false;
      count--;
      selectionMessage.textContent = `Em ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${MAX_SELECTIONS} ·∫£nh!`;
      setTimeout(() => {
        selectionMessage.textContent = '';
      }, 2000);
    } else {
      selectionMessage.textContent = '';
    }
    selectedCountSpan.textContent = count;
  }
  
  function downloadSelectedPhotos() {
    const checkedBoxes = document.querySelectorAll('.photo-item input[type="checkbox"]:checked');
    if (checkedBoxes.length !== MAX_SELECTIONS) {
      alert(`Em ∆°i, em c·∫ßn ch·ªçn ƒê√öNG ${MAX_SELECTIONS} ·∫£nh ƒë·ªÉ gh√©p khung nha ü•∞`);
      return;
    }
    const imageSources = [];
    checkedBoxes.forEach(cb => {
      const img = cb.closest('.photo-item').querySelector('img');
      imageSources.push(img.src);
    });
    composeAndDownload(imageSources);
  }
  
  async function composeAndDownload(imageSources) {
    
    const finalCanvas = document.createElement('canvas');
    const ctx = finalCanvas.getContext('2d');
    
    const finalWidth = 1920;
    const finalHeight = 1080;
    
    finalCanvas.width = finalWidth;
    finalCanvas.height = finalHeight;
    
    // 1. V·∫Ω n·ªÅn
    const gradient = ctx.createLinearGradient(0, 0, 0, finalHeight);
    gradient.addColorStop(0, '#fde4ea');
    gradient.addColorStop(1, '#d8d8f8');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, finalWidth, finalHeight);
    
    // 2. T·∫£i 6 t·∫•m ·∫£nh
    const imagePromises = imageSources.map(src => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = (e) => reject(new Error('L·ªói t·∫£i ·∫£nh ƒë√£ ch·ª•p: ' + e));
        img.src = src;
      });
    });
    
    let loadedImages;
    try {
        loadedImages = await Promise.all(imagePromises);
    } catch (e) {
        console.error(e);
        alert('L·ªói khi t·∫£i ·∫£nh, kh√¥ng th·ªÉ t·∫°o khung.');
        return;
    }

    // 3. B·ªë c·ª•c 3 C·ªòT, 2 H√ÄNG (3x2)
    const gridCols = 3;
    const gridRows = 2;
    const gridPadding = 25;
    
    const innerFrameWidth = 1600;
    const innerFrameHeight = 825;
    const innerFrameX = (finalWidth - innerFrameWidth) / 2;
    const innerFrameY = (finalHeight - innerFrameHeight) / 2;
    
    const photoWidth = (innerFrameWidth - (gridPadding * (gridCols + 1))) / gridCols;
    const photoHeight = (innerFrameHeight - (gridPadding * (gridRows + 1))) / gridRows;
                                                             
    // V·∫Ω khung tr·∫Øng
    ctx.fillStyle = 'white';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 15;
    
    if (ctx.roundRect) {
      ctx.beginPath();
      ctx.roundRect(innerFrameX, innerFrameY, innerFrameWidth, innerFrameHeight, 20);
      ctx.fill();
    } else {
      ctx.fillRect(innerFrameX, innerFrameY, innerFrameWidth, innerFrameHeight);
    }
    ctx.shadowColor = 'transparent';

    // 4. V·∫Ω 6 t·∫•m ·∫£nh (v√† l∆∞u l·∫°i v·ªã tr√≠)
    const forbiddenRects = [];
    let imageIndex = 0;
    for (let row = 0; row < gridRows; row++) {
      for (let col = 0; col < gridCols; col++) {
        if (!loadedImages[imageIndex]) continue;
        
        const x = innerFrameX + (gridPadding * (col + 1)) + (photoWidth * col);
        const y = innerFrameY + (gridPadding * (row + 1)) + (photoHeight * row);
        
        forbiddenRects.push({ x: x, y: y, w: photoWidth, h: photoHeight });
        
        const img = loadedImages[imageIndex];
        const frameRatio = photoWidth / photoHeight;
        
        let sWidth, sHeight, sX, sY;
        
        sHeight = img.height;
        sWidth = img.height * frameRatio;
        sX = (img.width - sWidth) / 2;
        sY = 0;
        
        ctx.save();
        ctx.beginPath();
        if (ctx.roundRect) {
            ctx.roundRect(x, y, photoWidth, photoHeight, 15);
            ctx.clip();
        } else {
            ctx.rect(x, y, photoWidth, photoHeight);
            ctx.clip();
        }
        
        ctx.drawImage(
            img,
            sX, sY, sWidth, sHeight,
            x, y, photoWidth, photoHeight
        );
        ctx.restore();
        
        ctx.strokeStyle = '#ffb6c1';
        ctx.lineWidth = 4;
        if (ctx.roundRect) {
            ctx.beginPath();
            ctx.roundRect(x, y, photoWidth, photoHeight, 15);
            ctx.stroke();
        } else {
            ctx.strokeRect(x, y, photoWidth, photoHeight);
        }
        
        imageIndex++;
      }
    }
    
    // 5. V·∫Ω Stickers v√† tr√°i tim
    ctx.globalAlpha = 0.9;
    
    // V√πng an to√†n cho ch·ªØ v√† sticker g√≥c
    ctx.font = '80px "Dancing Script", cursive';
    ctx.fillStyle = '#ff69b4';
    ctx.textAlign = 'center';
    ctx.fillText('LOVE U 4EVER <3', finalWidth / 2, 90);
    ctx.textAlign = 'left';
    const headerRect = { x: finalWidth/2 - 350, y: 0, w: 700, h: 120 };
    forbiddenRects.push(headerRect); // Th√™m v√πng ch·ªØ v√†o v√πng c·∫•m

    // C√°c sticker c·ªë ƒë·ªãnh ·ªü g√≥c (c√≥ th√™m sticker m·ªõi)
    const staticStickers = [
        { id: 'svg-cloud', x: 40, y: 40, w: 150, h: 100 },
        { id: 'svg-cupcake', x: 200, y: 110, w: 80, h: 80 },
        { id: 'svg-frog', x: 1730, y: 40, w: 130, h: 110 },
        { id: 'svg-cat', x: 1710, y: 880, w: 150, h: 150 },
        { id: 'svg-lollipop', x: 1630, y: 890, w: 120, h: 120 },
        { id: 'svg-bear', x: 40, y: 880, w: 150, h: 150 },
        { id: 'svg-gift', x: 180, y: 920, w: 100, h: 100 },
        { id: 'svg-chick', x: 40, y: finalHeight / 2 - 50, w: 100, h: 100 }, // V·ªã tr√≠ m·ªõi
        { id: 'svg-christmas-tree', x: finalWidth - 140, y: finalHeight / 2 - 50, w: 100, h: 100 }, // V·ªã tr√≠ m·ªõi
        { id: 'svg-duck', x: finalWidth / 2 - 50, y: finalHeight - 120, w: 100, h: 100 } // V·ªã tr√≠ m·ªõi
    ];

    for(const s of staticStickers) {
        if (stickerImages[s.id]) {
            ctx.drawImage(stickerImages[s.id], s.x, s.y, s.w, s.h);
            forbiddenRects.push({ x: s.x, y: s.y, w: s.w, h: s.h }); // Th√™m v√†o v√πng c·∫•m
        }
    }
    ctx.globalAlpha = 1.0;

    // 6. V·∫Ω tr√°i tim (v·∫´n gi·ªØ)
    function drawHeart(x, y, size, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(x, y + size / 4);
        ctx.quadraticCurveTo(x, y, x + size / 4, y);
        ctx.quadraticCurveTo(x + size / 2, y, x + size / 2, y + size / 4);
        ctx.quadraticCurveTo(x + size / 2, y, x + (size * 3/4), y);
        ctx.quadraticCurveTo(x + size, y, x + size, y + size / 4);
        ctx.quadraticCurveTo(x + size, y + size / 2, x + size / 2, y + size * 3/4);
        ctx.quadraticCurveTo(x, y + size / 2, x, y + size / 4);
        ctx.fill();
        forbiddenRects.push({x: x, y: y, w: size, h: size * 3/4}); // Th√™m v√πng tr√°i tim v√†o v√πng c·∫•m
    }
    
    drawHeart(300, 50, 40, '#FF69B4');
    drawHeart(1550, 90, 30, '#FF69B4');
    drawHeart(1800, 300, 50, '#FF69B4');
    drawHeart(100, 500, 35, '#FFB6C1');
    drawHeart(50, 800, 40, '#FF69B4');
    drawHeart(1600, 850, 30, '#FFB6C1');
    drawHeart(1850, 700, 40, '#FF69B4');
    
    // 7. V·∫Ω EMOJI (to h∆°n + tr√°nh ch·ªìng ch√©o)
    if (userEmojis && userEmojis.length > 0) {
        const emojiSize = 128;
        ctx.font = `${emojiSize}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        const emojis = Array.from(userEmojis).slice(0, MAX_EMOJIS);
        
        for (const emoji of emojis) {
            let x, y, isOverlapping;
            let attempts = 0;
            const maxAttempts = 200; // TƒÉng s·ªë l·∫ßn th·ª≠
            
            do {
                isOverlapping = false;
                // T·∫°o v·ªã tr√≠ ng·∫´u nhi√™n trong kho·∫£ng an to√†n
                x = Math.random() * (finalWidth - emojiSize * 2 - EMOJI_RANDOM_AREA_PADDING * 2) + emojiSize + EMOJI_RANDOM_AREA_PADDING;
                y = Math.random() * (finalHeight - emojiSize * 2 - EMOJI_RANDOM_AREA_PADDING * 2) + emojiSize + EMOJI_RANDOM_AREA_PADDING;
                
                // Ki·ªÉm tra xem c√≥ ƒë√® l√™n v√πng c·∫•m (·∫£nh + ch·ªØ + sticker + emoji kh√°c)
                for (const rect of forbiddenRects) {
                    const padding = emojiSize / 2;
                    if (x + emojiSize/2 > rect.x - padding && x - emojiSize/2 < rect.x + rect.w + padding &&
                        y + emojiSize/2 > rect.y - padding && y - emojiSize/2 < rect.y + rect.h + padding) {
                        isOverlapping = true;
                        break;
                    }
                }
                attempts++;
            } while (isOverlapping && attempts < maxAttempts);

            if (!isOverlapping) {
                ctx.fillText(emoji, x, y);
                // Th√™m v·ªã tr√≠ m·ªõi c·ªßa emoji v√†o v√πng c·∫•m ƒë·ªÉ c√°c emoji sau kh√¥ng ƒë√® l√™n
                forbiddenRects.push({ x: x - emojiSize/2, y: y - emojiSize/2, w: emojiSize, h: emojiSize });
            } else {
                console.warn(`Kh√¥ng t√¨m ƒë∆∞·ª£c v·ªã tr√≠ ph√π h·ª£p cho emoji "${emoji}" sau ${maxAttempts} l·∫ßn th·ª≠.`);
            }
        }
    }
    
    // 8. T·∫£i ·∫£nh v·ªÅ
    const finalDataURL = finalCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = finalDataURL;
    a.download = 'photobooth_phuongthy_frame.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  
});
</script>
</body>
</html>
