<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M√≥n qu√† nh·ªè c·ªßa anh</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Inter', Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: #fffacd;
  padding: 20px;
  position: relative;
  min-height: 100vh;
  box-sizing: border-box;
  justify-content: center
}

h1, h2 {
  color: #333;
  margin-bottom: 5px;
  font-weight: 700
}

p.subtitle {
  font-size: 1em;
  color: #666;
  margin-top: 0;
  margin-bottom: 20px
}

#loginContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  background: white;
  padding: 30px 40px;
  border-radius: 12px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 400px
}

#loginContainer h2 {
  margin-top: 0;
  margin-bottom: 20px
}

#loginContainer div {
  margin-bottom: 15px;
  width: 100%
}

#loginContainer label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #555
}

#loginContainer input[type="text"],
#loginContainer input[type="password"] {
  width: 100%;
  padding: 12px;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  font-size: 16px
}

#loginError {
  color: #dc3545;
  font-size: 14px;
  height: 20px;
  text-align: center
}

#loginButton {
  background-color: #ff69b4;
}

.loginButton:hover {
  background-color: #e0529d
}

.hidden {
  display: none !important
}

#photoboothApp {
  display: none;
  flex-direction: column;
  align-items: center;
  width: 100%
}

.booth-container {
  display: flex;
  flex-direction: column;
  gap: 0;
  align-items: center;
  justify-content: center;
  margin: 25px 0;
  width: 100%;
  max-width: 640px;
}

video {
  width: 100%;
  height: auto;
  aspect-ratio: 16 / 9;
  object-fit: cover;
  transform: scaleX(-1);
  border: 6px solid #ff69b4;
  border-radius: 15px;
  background-color: white;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
  transition: filter 0.3s ease; /* Chuy·ªÉn ƒë·ªông filter m∆∞·ª£t m√† */
}

/* Canvas d√πng ƒë·ªÉ ch·ª•p ·∫£nh, s·∫Ω b·ªã ·∫©n ƒëi */
canvas {
  display: none;
}

button {
  padding: 10px 20px;
  margin: 5px;
  background-color: #ff69b4;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: background-color 0.3s, transform 0.2s;
  font-size: 16px
}

button:hover {
  background-color: #e0529d;
  transform: translateY(-2px)
}

button:disabled {
  background-color: #ccc;
  cursor: not-allowed;
  transform: none !important
}

#controls {
  margin-bottom: 15px
}

#statusContainer {
  display: flex;
  justify-content: space-around;
  width: 100%;
  max-width: 700px;
  background: #fff;
  padding: 18px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  margin-top: 20px
}

.status-item {
  text-align: center;
  font-size: 19px;
  font-weight: bold;
  color: #444
}

.status-item span {
  display: block;
  font-size: 26px;
  color: #ff69b4;
  margin-top: 6px
}

#filterControls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 8px;
  margin-bottom: 20px
}

.filter-btn {
  background-color: #f8c5e0;
  color: #555;
  font-size: 13px;
  padding: 7px 14px;
  border-radius: 20px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1)
}

.filter-btn:hover {
  background-color: #f5b0d0
}

#takePhotoBtn {
  background-color: #8e2de2
}

.takePhotoBtn:hover {
  background-color: #741bb7
}

#restartButton {
  background-color: #ffd700;
  color: #333
}

.restartButton:hover {
  background-color: #e6c200
}

#downloadButton {
  background-color: #00bfff
}

.downloadButton:hover {
  background-color: #0099cc
}

.photo-actions button {
  background-color: #ff4d4d
}

.photo-actions button:hover {
  background-color: #e63939
}

.gallery {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
  gap: 12px;
  width: 100%;
  max-width: 800px;
  margin-top: 25px
}

.photo-item {
  position: relative;
  border-radius: 12px;
  overflow: hidden;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  padding-bottom: 8px;
  transition: transform 0.2s ease
}

.photo-item:hover {
  transform: translateY(-5px)
}

.photo-item img {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 10px
}

.photo-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 8px
}

.photo-actions input[type="checkbox"] {
  transform: scale(1.3);
  cursor: pointer
}

.photo-actions input[type="checkbox"]:disabled {
  cursor: not-allowed
}

.counter {
  margin: 10px;
  font-size: 17px;
  color: #444;
  font-weight: bold
}

#selectionMessage {
  color: #dc3545;
  font-size: 15px;
  height: 22px;
  font-weight: bold
}
</style>
</head>

<body>
<div id="loginContainer">
  <h2>üîí ƒêƒÉng nh·∫≠p PhotoBooth ƒëeeeeeeee</h2>
  <div>
    <label for="username">T√†i kho·∫£n:</label>
    <input type="text" id="username" name="username">
  </div>
  <div>
    <label for="password">M·∫≠t kh·∫©u:</label>
    <input type="password" id="password" name="password">
  </div>
  <p id="loginError"></p>
  <button id="loginButton">ƒêƒÉng nh·∫≠p nh√≥oo</button>
</div>
<div id="photoboothApp" class="hidden">
  <h1>‚ú® PhotoBooth c·ªßa Ph∆∞∆°ng Thy ‚ú®</h1>
  <p class="subtitle">em b√© iu c·ªßa NT :3</p>
  <div id="statusContainer">
    <div class="status-item">Th·ªùi gian<span id="timerDisplay">20</span></div>
    <div class="status-item">S·ªë ·∫£nh<span id="photoCountDisplay">0 / 10</span></div>
  </div>
  <div class="booth-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>
  <div id="filterControls">
    <button class="filter-btn" data-filter="none">B√¨nh th∆∞·ªùng</button>
    <button class="filter-btn" data-filter="tokyo">Tokyo</button>
    <button class="filter-btn" data-filter="seoul">Seoul</button>
    <button class="filter-btn" data-filter="paris">Paris</button>
  </div>
  <div id="controls">
    <button id="startButton">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
    <button id="takePhotoBtn" class="hidden">üì∏ Ch·ª•p ·∫¢nh</button>
    <button id="restartButton" class="hidden">üîÑ L√†m l·∫°i</button>
  </div>
  <hr style="width: 80%; border: 1px solid #ddd; margin: 15px 0;">
  <h2>Th∆∞ vi·ªán ·∫£nh</h2>
  <p>Sau khi ch·ª•p xong, em ch·ªçn t·ªëi ƒëa 6 ·∫£nh ƒë·∫πp nh·∫•t</p>
  <div class="counter">·∫¢nh ƒë√£ ch·ªçn: <span id="selectedCount">0</span> / 6</div>
  <p id="selectionMessage"></p>
  <div class="gallery" id="photoGallery"></div>
  <button id="downloadButton" disabled>‚¨áÔ∏è T·∫£i 6 ·∫£nh ƒë√£ ch·ªçn v·ªÅ khung</button>
</div>

<div id="stickerAssets" style="display: none;">
  <svg id="svg-bear" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-cat" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2ZM7.5 7.5C7.5 6.67157 8.17157 6 9 6C9.82843 6 10.5 6.67157 10.5 7.5C10.5 8.32843 9.82843 9 9 9C8.17157 9 7.5 8.32843 7.5 7.5ZM13.5 7.5C13.5 6.67157 14.1716 6 15 6C15.8284 6 16.5 6.67157 16.5 7.5C16.5 8.32843 15.8284 9 15 9C14.1716 9 13.5 8.32843 13.5 7.5ZM12 11.5C10.6193 11.5 9.5 12.6193 9.5 14C9.5 15.3807 10.6193 16.5 12 16.5C13.3807 16.5 14.5 15.3807 14.5 14C14.5 12.6193 13.3807 11.5 12 11.5ZM3 9C3 8.44772 3.44772 8 4 8H6C6.55228 8 7 8.44772 7 9C7 9.55228 6.55228 10 6 10H4C3.44772 10 3 9.55228 3 9ZM18 9C18 8.44772 18.4477 8 19 8H21C21.5523 8 22 8.44772 22 9C22 9.55228 21.5523 10 21 10H19C18.4477 10 18 9.55228 18 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-cloud" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-lollipop" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C7.03194 2 3 6.03194 3 11C3 15.9681 7.03194 20 12 20C16.9681 20 21 15.9681 21 11C21 6.03194 16.9681 2 12 2ZM12 4C15.866 4 19 7.13401 19 11C19 14.866 15.866 18 12 18C8.13401 18 5 14.866 5 11C5 7.13401 8.13401 4 12 4ZM12 6C11.4477 6 11 6.44772 11 7C11 7.55228 11.4477 8 12 8C12.5523 8 13 7.55228 13 7C13 6.44772 12.5523 6 12 6ZM12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-cupcake" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-gift" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C8.13401 2 5 5.13401 5 9C5 12.866 8.13401 16 12 16C15.866 16 19 12.866 19 9C19 5.13401 15.866 2 12 2ZM7.5 7.5C7.5 6.67157 8.17157 6 9 6C9.82843 6 10.5 6.67157 10.5 7.5C10.5 8.32843 9.82843 9 9 9C8.17157 9 7.5 8.32843 7.5 7.5ZM13.5 7.5C13.5 6.67157 14.1716 6 15 6C15.8284 6 16.5 6.67157 16.5 7.5C16.5 8.32843 15.8284 9 15 9C14.1716 9 13.5 8.32843 13.5 7.5ZM12 11.5C10.6193 11.5 9.5 12.6193 9.5 14C9.5 15.3807 10.6193 16.5 12 16.5C13.3807 16.5 14.5 15.3807 14.5 14C14.5 12.6193 13.3807 11.5 12 11.5ZM3 9C3 8.44772 3.44772 8 4 8H6C6.55228 8 7 8.44772 7 9C7 9.55228 6.55228 10 6 10H4C3.44772 10 3 9.55228 3 9ZM18 9C18 8.44772 18.4477 8 19 8H21C21.5523 8 22 8.44772 22 9C22 9.55228 21.5523 10 21 10H19C18.4477 10 18 9.55228 18 9Z" fill="#ffb6c1"/>
  </svg>
  <svg id="svg-frog" width="100" height="100" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C9.79086 2 8 3.79086 8 6C8 7.05436 8.35821 8.01972 8.97103 8.78494C6.39162 9.53034 4.5 11.8906 4.5 14.667C4.5 17.5191 6.38885 19.8824 9.02029 20.612C9.52295 22.0945 10.6698 23 12 23C13.3302 23 14.477 22.0945 14.9797 20.612C17.6111 19.8824 19.5 17.5191 19.5 14.667C19.5 11.8906 17.6084 9.53034 15.029 8.78494C15.6418 8.01972 16 7.05436 16 6C16 3.79086 14.2091 2 12 2ZM12 4C13.1046 4 14 4.89543 14 6C14 7.10457 13.1046 8 12 8C10.8954 8 10 7.10457 10 6C10 4.89543 10.8954 4 12 4ZM10 12C9.44772 12 9 12.4477 9 13C9 13.5523 9.44772 14 10 14H14C14.5523 14 15 13.5523 15 13C15 12.4477 14.5523 12 14 12H10Z" fill="#ffb6c1"/>
  </svg>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const TIME_LIMIT = 20;
  const MAX_PHOTOS = 10;
  const MAX_SELECTIONS = 6;
  let timer;
  let timeLeft = TIME_LIMIT;
  let photoCount = 0;
  let isSessionActive = false;
  let currentFilterStyle = 'none'; // S·ª≠a: D√πng tr·ª±c ti·∫øp style
  const loginContainer = document.getElementById('loginContainer');
  const photoboothApp = document.getElementById('photoboothApp');
  const loginButton = document.getElementById('loginButton');
  const usernameInput = document.getElementById('username');
  const passwordInput = document.getElementById('password');
  const loginError = document.getElementById('loginError');
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const context = canvas.getContext('2d');
  const photoGallery = document.getElementById('photoGallery');
  const selectedCountSpan = document.getElementById('selectedCount');
  const startButton = document.getElementById('startButton');
  const takePhotoBtn = document.getElementById('takePhotoBtn');
  const restartButton = document.getElementById('restartButton');
  const downloadButton = document.getElementById('downloadButton');
  const timerDisplay = document.getElementById('timerDisplay');
  const photoCountDisplay = document.getElementById('photoCountDisplay');
  const selectionMessage = document.getElementById('selectionMessage');
  const filterButtons = document.querySelectorAll('#filterControls .filter-btn');

  // H√†m ƒë·ªÉ chuy·ªÉn SVG th√†nh Image cho Canvas
  async function svgToImage(svgElement, width, height) {
      return new Promise((resolve, reject) => {
          const svgData = new XMLSerializer().serializeToString(svgElement);
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = (e) => reject(new Error('L·ªói chuy·ªÉn SVG th√†nh ·∫£nh: ' + e));
          img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
      });
  }

  // T·∫£i t·∫•t c·∫£ c√°c sticker SVG th√†nh Image m·ªôt l·∫ßn
  const stickerImages = {};
  async function loadSvgStickers() {
      const stickerIds = ['svg-bear', 'svg-cat', 'svg-cloud', 'svg-lollipop', 'svg-cupcake', 'svg-gift', 'svg-frog'];
      for (const id of stickerIds) {
          const svgElement = document.getElementById(id);
          if (svgElement) {
              try {
                  // Gi·∫£ ƒë·ªãnh k√≠ch th∆∞·ªõc m·∫∑c ƒë·ªãnh cho SVG n·∫øu kh√¥ng ƒë∆∞·ª£c truy·ªÅn v√†o
                  const img = await svgToImage(svgElement, 100, 100); 
                  stickerImages[id] = img;
              } catch (e) {
                  console.error(`Kh√¥ng th·ªÉ t·∫£i sticker ${id}:`, e);
              }
          }
      }
  }
  
  // G·ªçi h√†m n√†y khi kh·ªüi t·∫°o ·ª©ng d·ª•ng
  loadSvgStickers();

  loginButton.addEventListener('click', function() {
    const username = usernameInput.value;
    const password = passwordInput.value;
    if (username === 'Nguyentranphuongthy' && password === '07022007') {
      loginContainer.classList.add('hidden');
      photoboothApp.style.display = 'flex';
      photoboothApp.classList.remove('hidden');
      
      startCamera();
      resetUI();
      
    } else {
      loginError.textContent = 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u r√πi nhaaa :33';
    }
  });
  
  startButton.addEventListener('click', startSession);
  takePhotoBtn.addEventListener('click', takePhoto);
  restartButton.addEventListener('click', restartSession);
  downloadButton.addEventListener('click', downloadSelectedPhotos);
  
  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filter = button.dataset.filter;
      applyFilter(filter);
    });
  });
  
  function startCamera() {
    let constraints = {
      video: {
        width: { ideal: 1920 },
        height: { ideal: 1080 },
        facingMode: 'user'
      }
    };

    navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
      video.srcObject = stream;
    }).catch(error => {
      console.error('L·ªói khi l·∫•y camera 1920x1080:', error);
      navigator.mediaDevices.getUserMedia({ video: true, audio: false })
        .then(stream => {
          video.srcObject = stream;
        }).catch(err2 => {
          alert('Kh√¥ng th·ªÉ truy c·∫≠p camera: ' + err2.message);
        });
    });
  }
  
  // === H√ÄM FILTER M·ªöI (D√ôNG STYLE TR·ª∞C TI·∫æP) ===
  function applyFilter(filter) {
    let filterValue = 'none';
    switch (filter) {
      case 'tokyo':
        filterValue = 'contrast(1.1) brightness(1.1) saturate(0)'; // T√¥ng m√†u l·∫°nh, √≠t m√†u
        break;
      case 'seoul':
        filterValue = 'saturate(1.3) contrast(1.1) sepia(0.2)'; // T√¥ng m√†u ·∫•m, t∆∞∆°i s√°ng
        break;
      case 'paris':
        filterValue = 'contrast(0.9) brightness(1.2) saturate(0.8) hue-rotate(-10deg)'; // T√¥ng m√†u tr·∫ßm, c·ªï ƒëi·ªÉn
        break;
      case 'none':
      default:
        filterValue = 'none';
    }
    video.style.filter = filterValue;
    currentFilterStyle = filterValue;
  }
  
  function resetUI() {
    clearInterval(timer);
    photoGallery.innerHTML = '';
    timeLeft = TIME_LIMIT;
    photoCount = 0;
    isSessionActive = false;
    timerDisplay.textContent = timeLeft;
    photoCountDisplay.textContent = `0 / ${MAX_PHOTOS}`;
    selectedCountSpan.textContent = '0';
    selectionMessage.textContent = '';
    
    // Reset filter
    video.style.filter = 'none';
    currentFilterStyle = 'none';
    
    startButton.classList.remove('hidden');
    takePhotoBtn.classList.add('hidden');
    restartButton.classList.add('hidden');
    downloadButton.disabled = true;
    disableCheckboxes(true);
  }
  
  function startSession() {
    isSessionActive = true;
    startButton.classList.add('hidden');
    takePhotoBtn.classList.remove('hidden');
    restartButton.classList.remove('hidden');
    timer = setInterval(updateTimer, 1000);
  }
  
  function updateTimer() {
    timeLeft--;
    timerDisplay.textContent = timeLeft;
    if (timeLeft <= 0) {
      endSession();
    }
  }
  
  function endSession() {
    clearInterval(timer);
    isSessionActive = false;
    timerDisplay.textContent = "H·∫øt gi·ªù :)))";
    takePhotoBtn.classList.add('hidden');
    disableCheckboxes(false);
    downloadButton.disabled = false;
    alert(`ƒê√£ h·∫øt! Em ƒë√£ ch·ª•p ${photoCount} ·∫£nh. Gi·ªù h√£y ch·ªçn t·ªëi ƒëa ${MAX_SELECTIONS} ·∫£nh ƒë·∫πp nh·∫•t.`);
  }
  
  function restartSession() {
    if (confirm('Em c√≥ ch·∫Øc mu·ªën l√†m l·∫°i hongg. To√†n b·ªô ·∫£nh ƒë√£ ch·ª•p s·∫Ω b·ªã x√≥a √° :))).')) {
      resetUI();
    }
  }
  
  function disableCheckboxes(isDisabled) {
    const checkboxes = document.querySelectorAll('.photo-item input[type="checkbox"]');
    checkboxes.forEach(cb => {
      cb.disabled = isDisabled;
    });
  }

  
  function takePhoto() {
    if (!isSessionActive || photoCount >= MAX_PHOTOS) {
      return;
    }
    photoCount++;
    photoCountDisplay.textContent = `${photoCount} / ${MAX_PHOTOS}`;
    
    // Logic ch·ª•p ·∫£nh 16:9 (crop)
    const vWidth = video.videoWidth;
    const vHeight = video.videoHeight;
    const vRatio = vWidth / vHeight;
    
    const targetWidth = 1920;
    const targetHeight = 1080;
    const targetRatio = targetWidth / targetHeight;
    
    canvas.width = targetWidth;
    canvas.height = targetHeight;
    
    let sWidth, sHeight, sX, sY;

    if (vRatio > targetRatio) {
        sHeight = vHeight;
        sWidth = vHeight * targetRatio;
        sX = (vWidth - sWidth) / 2; // C·∫Øt 2 b√™n
        sY = 0;
    } else {
        sWidth = vWidth;
        sHeight = vWidth / targetRatio;
        sX = 0;
        sY = (vHeight - sHeight) / 2; // C·∫Øt tr√™n d∆∞·ªõi
    }
    
    // √Åp d·ª•ng filter (t·ª´ style) v√†o canvas
    context.filter = currentFilterStyle;
    
    context.drawImage(
        video,
        sX, sY, sWidth, sHeight,
        0, 0, targetWidth, targetHeight
    );
    context.filter = 'none'; // Reset filter cho canvas sau khi v·∫Ω
    
    const dataURL = canvas.toDataURL('image/png');
    addPhotoToGallery(dataURL);
    
    if (photoCount >= MAX_PHOTOS) {
      endSession();
    }
  }
  
  function addPhotoToGallery(dataURL) {
    const photoItem = document.createElement('div');
    photoItem.className = 'photo-item';
    // ·∫¢nh preview trong gallery l·∫≠t l·∫°i ƒë·ªÉ kh·ªõp v·ªõi video
    photoItem.innerHTML = `<img src="${dataURL}" style="transform: scaleX(-1);">`;
    
    const actions = document.createElement('div');
    actions.className = 'photo-actions';
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.disabled = true;
    checkbox.onchange = (e) => updateSelectedCount(e);
    
    actions.appendChild(checkbox);
    photoItem.appendChild(actions);
    photoGallery.appendChild(photoItem);
  }
  
  function updateSelectedCount(event) {
    const checkboxes = document.querySelectorAll('.photo-item input[type="checkbox"]');
    let count = 0;
    checkboxes.forEach(cb => {
      if (cb.checked) count++;
    });
    if (count > MAX_SELECTIONS) {
      event.target.checked = false;
      count--;
      selectionMessage.textContent = `Em ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${MAX_SELECTIONS} ·∫£nh!`;
      setTimeout(() => {
        selectionMessage.textContent = '';
      }, 2000);
    } else {
      selectionMessage.textContent = '';
    }
    selectedCountSpan.textContent = count;
  }
  
  function downloadSelectedPhotos() {
    const checkedBoxes = document.querySelectorAll('.photo-item input[type="checkbox"]:checked');
    if (checkedBoxes.length !== MAX_SELECTIONS) {
      alert(`Em c·∫ßn ph·∫£i ch·ªçn ƒê√öNG ${MAX_SELECTIONS} ·∫£nh ƒë·ªÉ gh√©p khung nhaaa`);
      return;
    }
    const imageSources = [];
    checkedBoxes.forEach(cb => {
      // L·∫•y ·∫£nh g·ªëc (kh√¥ng l·∫≠t)
      const img = cb.closest('.photo-item').querySelector('img');
      imageSources.push(img.src);
    });
    // G·ªçi h√†m V·∫º KHUNG M·ªöI
    composeAndDownload(imageSources);
  }
  
  // === H√ÄM V·∫º KHUNG ·∫¢NH M·ªöI (THEO M·∫™U + STICKER SVG) ===
  async function composeAndDownload(imageSources) {
    
    const finalCanvas = document.createElement('canvas');
    const ctx = finalCanvas.getContext('2d');
    
    const finalWidth = 1920;
    const finalHeight = 1080;
    
    finalCanvas.width = finalWidth;
    finalCanvas.height = finalHeight;
    
    // 1. V·∫Ω n·ªÅn gradient (h·ªìng -> t√≠m nh·∫°t)
    const gradient = ctx.createLinearGradient(0, 0, 0, finalHeight);
    gradient.addColorStop(0, '#fde4ea'); // H·ªìng nh·∫°t
    gradient.addColorStop(1, '#d8d8f8'); // T√≠m nh·∫°t
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, finalWidth, finalHeight);
    
    // 2. T·∫£i 6 t·∫•m ·∫£nh ƒë√£ ch·ªçn
    const imagePromises = imageSources.map(src => {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = (e) => reject(new Error('L·ªói t·∫£i ·∫£nh ƒë√£ ch·ª•p: ' + e));
        img.src = src;
      });
    });
    
    let loadedImages;
    try {
        loadedImages = await Promise.all(imagePromises);
    } catch (e) {
        console.error(e);
        alert('L·ªói khi t·∫£i ·∫£nh ƒë√£ ch·ª•p, kh√¥ng th·ªÉ t·∫°o khung.');
        return;
    }

    // 3. T√≠nh to√°n b·ªë c·ª•c 3 C·ªòT, 2 H√ÄNG (3x2)
    const gridCols = 3;
    const gridRows = 2;
    const gridPadding = 25; // Kho·∫£ng c√°ch gi·ªØa c√°c ·∫£nh v√† vi·ªÅn khung
    
    // K√≠ch th∆∞·ªõc khung tr·∫Øng b√™n trong
    const innerFrameWidth = 1600;
    const innerFrameHeight = 825;
    const innerFrameX = (finalWidth - innerFrameWidth) / 2; // (1920 - 1600) / 2 = 160
    const innerFrameY = (finalHeight - innerFrameHeight) / 2; // (1080 - 825) / 2 = 127.5
    
    // K√≠ch th∆∞·ªõc m·ªói ·∫£nh (t·ªâ l·ªá 4:3)
    const photoWidth = (innerFrameWidth - (gridPadding * (gridCols + 1))) / gridCols; // (1600 - (25*4)) / 3 = 500
    const photoHeight = (innerFrameHeight - (gridPadding * (gridRows + 1))) / gridRows; // (825 - (25*3)) / 2 = 375
                                                             
    // V·∫Ω khung tr·∫Øng b√™n d∆∞·ªõi
    ctx.fillStyle = 'white';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.2)';
    ctx.shadowBlur = 15;
    
    // H·ªó tr·ª£ roundRect ho·∫∑c fallback v·ªÅ rect
    if (ctx.roundRect) {
      ctx.beginPath();
      ctx.roundRect(innerFrameX, innerFrameY, innerFrameWidth, innerFrameHeight, 20);
      ctx.fill();
    } else {
      ctx.fillRect(innerFrameX, innerFrameY, innerFrameWidth, innerFrameHeight);
    }
    ctx.shadowColor = 'transparent';

    // 4. V·∫Ω 6 t·∫•m ·∫£nh
    let imageIndex = 0;
    for (let row = 0; row < gridRows; row++) {
      for (let col = 0; col < gridCols; col++) {
        if (!loadedImages[imageIndex]) continue;
        
        const x = innerFrameX + (gridPadding * (col + 1)) + (photoWidth * col);
        const y = innerFrameY + (gridPadding * (row + 1)) + (photoHeight * row);
        
        const img = loadedImages[imageIndex];
        const imgRatio = img.width / img.height; // 1.777 (16:9)
        const frameRatio = photoWidth / photoHeight; // 1.333 (4:3)
        
        let sWidth, sHeight, sX, sY;
        
        // C·∫Øt ·∫£nh 16:9 cho v·ª´a khung 4:3
        sHeight = img.height;
        sWidth = img.height * frameRatio;
        sX = (img.width - sWidth) / 2; // C·∫Øt 2 b√™n ƒë·ªÉ gi·ªØ ph·∫ßn trung t√¢m
        sY = 0;
        
        ctx.save(); // L∆∞u tr·∫°ng th√°i canvas
        ctx.beginPath();
        if (ctx.roundRect) {
            ctx.roundRect(x, y, photoWidth, photoHeight, 15); // Bo g√≥c cho ·∫£nh nh·ªè
            ctx.clip(); // C·∫Øt ·∫£nh theo ƒë∆∞·ªùng path n√†y
        } else {
            ctx.rect(x, y, photoWidth, photoHeight);
            ctx.clip();
        }
        
        ctx.drawImage(
            img,
            sX, sY, sWidth, sHeight,
            x, y, photoWidth, photoHeight
        );
        ctx.restore(); // Kh√¥i ph·ª•c tr·∫°ng th√°i canvas
        
        // V·∫Ω vi·ªÅn
        ctx.strokeStyle = '#ffb6c1';
        ctx.lineWidth = 4;
        if (ctx.roundRect) {
            ctx.beginPath();
            ctx.roundRect(x, y, photoWidth, photoHeight, 15);
            ctx.stroke();
        } else {
            ctx.strokeRect(x, y, photoWidth, photoHeight);
        }
        
        imageIndex++;
      }
    }
    
    // 5. V·∫Ω Stickers (L·∫•y t·ª´ ƒë·ªëi t∆∞·ª£ng stickerImages ƒë√£ ƒë∆∞·ª£c t·∫£i s·∫µn)
    try {
      ctx.globalAlpha = 0.9; // ƒê·ªô trong su·ªët nh·∫π cho sticker
      if (stickerImages['svg-cloud']) ctx.drawImage(stickerImages['svg-cloud'], 40, 40, 150, 100);
      if (stickerImages['svg-cupcake']) ctx.drawImage(stickerImages['svg-cupcake'], 200, 110, 80, 80);
      if (stickerImages['svg-frog']) ctx.drawImage(stickerImages['svg-frog'], 1730, 40, 130, 110);
      if (stickerImages['svg-cat']) ctx.drawImage(stickerImages['svg-cat'], 1710, 880, 150, 150);
      if (stickerImages['svg-lollipop']) ctx.drawImage(stickerImages['svg-lollipop'], 1630, 890, 120, 120);
      if (stickerImages['svg-bear']) ctx.drawImage(stickerImages['svg-bear'], 40, 880, 150, 150);
      if (stickerImages['svg-gift']) ctx.drawImage(stickerImages['svg-gift'], 180, 920, 100, 100);
      ctx.globalAlpha = 1.0;

      // Ch·ªØ "M√ìN QU√Ä NH·ªé C·ª¶A ANH"
      ctx.font = '70px Pacifico'; // S·ª≠ d·ª•ng font Pacifico
      ctx.fillStyle = '#ff69b4';
      ctx.textAlign = 'center';
      ctx.fillText('LOVE U 4EVER <3', finalWidth / 2, 80);
      ctx.textAlign = 'left'; // Reset v·ªÅ m·∫∑c ƒë·ªãnh

    } catch (e) {
      console.error("L·ªói khi v·∫Ω sticker ho·∫∑c ch·ªØ:", e);
    }
    
    // 6. V·∫Ω tr√°i tim (gi·ªØ nguy√™n, ho·∫°t ƒë·ªông t·ªët)
    function drawHeart(x, y, size, color) {
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(x, y + size / 4);
        ctx.quadraticCurveTo(x, y, x + size / 4, y);
        ctx.quadraticCurveTo(x + size / 2, y, x + size / 2, y + size / 4);
        ctx.quadraticCurveTo(x + size / 2, y, x + (size * 3/4), y);
        ctx.quadraticCurveTo(x + size, y, x + size, y + size / 4);
        ctx.quadraticCurveTo(x + size, y + size / 2, x + size / 2, y + size * 3/4);
        ctx.quadraticCurveTo(x, y + size / 2, x, y + size / 4);
        ctx.fill();
    }
    
    drawHeart(300, 50, 40, '#FF69B4');
    drawHeart(1550, 90, 30, '#FF69B4');
    drawHeart(1800, 300, 50, '#FF69B4');
    drawHeart(100, 500, 35, '#FFB6C1');
    drawHeart(50, 800, 40, '#FF69B4');
    drawHeart(1600, 850, 30, '#FFB6C1');
    drawHeart(1850, 700, 40, '#FF69B4');
    
    // 7. T·∫£i ·∫£nh v·ªÅ
    const finalDataURL = finalCanvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = finalDataURL;
    a.download = 'photobooth_phuongthy_frame.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
  
});
</script>
</body>
</html>
